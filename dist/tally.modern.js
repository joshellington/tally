var t,n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},i=(function(t){!function(n){function i(t,n){var i=(65535&t)+(65535&n);return(t>>16)+(n>>16)+(i>>16)<<16|65535&i}function e(t,n,e,o,a,r){return i((s=i(i(n,t),i(o,r)))<<(h=a)|s>>>32-h,e);var s,h}function o(t,n,i,o,a,r,s){return e(n&i|~n&o,t,n,a,r,s)}function a(t,n,i,o,a,r,s){return e(n&o|i&~o,t,n,a,r,s)}function r(t,n,i,o,a,r,s){return e(n^i^o,t,n,a,r,s)}function s(t,n,i,o,a,r,s){return e(i^(n|~o),t,n,a,r,s)}function h(t,n){var e,h,d,u,c;t[n>>5]|=128<<n%32,t[14+(n+64>>>9<<4)]=n;var l=1732584193,f=-271733879,g=-1732584194,v=271733878;for(e=0;e<t.length;e+=16)h=l,d=f,u=g,c=v,l=o(l,f,g,v,t[e],7,-680876936),v=o(v,l,f,g,t[e+1],12,-389564586),g=o(g,v,l,f,t[e+2],17,606105819),f=o(f,g,v,l,t[e+3],22,-1044525330),l=o(l,f,g,v,t[e+4],7,-176418897),v=o(v,l,f,g,t[e+5],12,1200080426),g=o(g,v,l,f,t[e+6],17,-1473231341),f=o(f,g,v,l,t[e+7],22,-45705983),l=o(l,f,g,v,t[e+8],7,1770035416),v=o(v,l,f,g,t[e+9],12,-1958414417),g=o(g,v,l,f,t[e+10],17,-42063),f=o(f,g,v,l,t[e+11],22,-1990404162),l=o(l,f,g,v,t[e+12],7,1804603682),v=o(v,l,f,g,t[e+13],12,-40341101),g=o(g,v,l,f,t[e+14],17,-1502002290),l=a(l,f=o(f,g,v,l,t[e+15],22,1236535329),g,v,t[e+1],5,-165796510),v=a(v,l,f,g,t[e+6],9,-1069501632),g=a(g,v,l,f,t[e+11],14,643717713),f=a(f,g,v,l,t[e],20,-373897302),l=a(l,f,g,v,t[e+5],5,-701558691),v=a(v,l,f,g,t[e+10],9,38016083),g=a(g,v,l,f,t[e+15],14,-660478335),f=a(f,g,v,l,t[e+4],20,-405537848),l=a(l,f,g,v,t[e+9],5,568446438),v=a(v,l,f,g,t[e+14],9,-1019803690),g=a(g,v,l,f,t[e+3],14,-187363961),f=a(f,g,v,l,t[e+8],20,1163531501),l=a(l,f,g,v,t[e+13],5,-1444681467),v=a(v,l,f,g,t[e+2],9,-51403784),g=a(g,v,l,f,t[e+7],14,1735328473),l=r(l,f=a(f,g,v,l,t[e+12],20,-1926607734),g,v,t[e+5],4,-378558),v=r(v,l,f,g,t[e+8],11,-2022574463),g=r(g,v,l,f,t[e+11],16,1839030562),f=r(f,g,v,l,t[e+14],23,-35309556),l=r(l,f,g,v,t[e+1],4,-1530992060),v=r(v,l,f,g,t[e+4],11,1272893353),g=r(g,v,l,f,t[e+7],16,-155497632),f=r(f,g,v,l,t[e+10],23,-1094730640),l=r(l,f,g,v,t[e+13],4,681279174),v=r(v,l,f,g,t[e],11,-358537222),g=r(g,v,l,f,t[e+3],16,-722521979),f=r(f,g,v,l,t[e+6],23,76029189),l=r(l,f,g,v,t[e+9],4,-640364487),v=r(v,l,f,g,t[e+12],11,-421815835),g=r(g,v,l,f,t[e+15],16,530742520),l=s(l,f=r(f,g,v,l,t[e+2],23,-995338651),g,v,t[e],6,-198630844),v=s(v,l,f,g,t[e+7],10,1126891415),g=s(g,v,l,f,t[e+14],15,-1416354905),f=s(f,g,v,l,t[e+5],21,-57434055),l=s(l,f,g,v,t[e+12],6,1700485571),v=s(v,l,f,g,t[e+3],10,-1894986606),g=s(g,v,l,f,t[e+10],15,-1051523),f=s(f,g,v,l,t[e+1],21,-2054922799),l=s(l,f,g,v,t[e+8],6,1873313359),v=s(v,l,f,g,t[e+15],10,-30611744),g=s(g,v,l,f,t[e+6],15,-1560198380),f=s(f,g,v,l,t[e+13],21,1309151649),l=s(l,f,g,v,t[e+4],6,-145523070),v=s(v,l,f,g,t[e+11],10,-1120210379),g=s(g,v,l,f,t[e+2],15,718787259),f=s(f,g,v,l,t[e+9],21,-343485551),l=i(l,h),f=i(f,d),g=i(g,u),v=i(v,c);return[l,f,g,v]}function d(t){var n,i="",e=32*t.length;for(n=0;n<e;n+=8)i+=String.fromCharCode(t[n>>5]>>>n%32&255);return i}function u(t){var n,i=[];for(i[(t.length>>2)-1]=void 0,n=0;n<i.length;n+=1)i[n]=0;var e=8*t.length;for(n=0;n<e;n+=8)i[n>>5]|=(255&t.charCodeAt(n/8))<<n%32;return i}function c(t){var n,i,e="0123456789abcdef",o="";for(i=0;i<t.length;i+=1)n=t.charCodeAt(i),o+=e.charAt(n>>>4&15)+e.charAt(15&n);return o}function l(t){return unescape(encodeURIComponent(t))}function f(t){return function(t){return d(h(u(t),8*t.length))}(l(t))}function g(t,n){return function(t,n){var i,e,o=u(t),a=[],r=[];for(a[15]=r[15]=void 0,o.length>16&&(o=h(o,8*t.length)),i=0;i<16;i+=1)a[i]=909522486^o[i],r[i]=1549556828^o[i];return e=h(a.concat(u(n)),512+8*n.length),d(h(r.concat(e),640))}(l(t),l(n))}function v(t,n,i){return n?i?g(n,t):c(g(n,t)):i?f(t):c(f(t))}t.exports?t.exports=v:n.md5=v}(n)}(t={exports:{}}),t.exports);export default class{constructor(t){var n=this;this.options=t,this.baseUrl=t.apiUrl?t.apiUrl:"https://tally-data-dev.s3.amazonaws.com",this.id=t.id?i(window.location.href+t.id.toString()).toString():i(window.location.href).toString(),this.interval=t.interval?t.interval:1e3,this.running=!1,this.count=0,this.loop=null,this.stop=this.stop,window.addEventListener("beforeunload",async function(t){n.unload()}),window.addEventListener("unload",async function(t){n.unload()}),document.addEventListener("visibilitychange",t=>{"hidden"===document.visibilityState||"unloaded"===document.visibilityState?this.unload():"visible"===document.visibilityState&&this.add()}),(["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document)&&(window.addEventListener("pagehide",t=>{this.unload()}),window.addEventListener("pageshow",t=>{this.add()})),this.start()}async start(){var t=this;this.running||(await this.add(),this.loop=setInterval(async function(){await t.get()},this.interval),this.running=!0)}dispatch(){const t=new CustomEvent("tally.change",{detail:{count:this.count,running:this.running}});window.dispatchEvent(t),this.options.change&&this.options.change({count:this.count,running:this.running})}async add(){await this.get(),await fetch(`${this.baseUrl}/${this.id}.txt`,{method:"put",body:this.count+1}),this.dispatch()}async get(){try{const t=await fetch(`${this.baseUrl}/${this.id}.txt`);if(!t.ok)throw new Error("NO FILE");this.count=parseInt(await t.text()),this.dispatch()}catch(t){console.log(t.message),await this.create(),await this.get()}}async create(){await fetch(`${this.baseUrl}/${this.id}.txt`,{method:"put",body:0})}unload(){fetch(`${this.baseUrl}/${this.id}.txt`,{method:"put",body:this.count>0?this.count-1:0,keepalive:!0})}stop(){clearInterval(this.loop),this.unload(),this.running=!1}}
//# sourceMappingURL=tally.modern.js.map
